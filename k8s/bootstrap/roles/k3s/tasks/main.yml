---
# ------------------------------------------------------------------------------
# K3s Cluster Bootstrap Logic
# -----

# 1. Detect the external IP of the master node (for TLS SAN)
- name: Detect external IP (multi-cloud)
  when: inventory_hostname in groups['k3s_master']
  shell: |
    curl -s -H "Metadata-Flavor: Google" \
      http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip \
    || hostname -I | awk '{print $1}'
  register: external_ip
  changed_when: false

# 2. Install K3s server (control plane)
- name: Install K3s on master
  when: inventory_hostname in groups['k3s_master']
  shell: |
    curl -sfL {{ k3s_install_url }} | \
      INSTALL_K3S_CHANNEL={{ k3s_channel }} \
      INSTALL_K3S_EXEC="server \
        --cluster-init \
        {{ k3s_server_args }} \
        --advertise-address {{ external_ip.stdout }} \
        --tls-san {{ external_ip.stdout }}" sh -
  args:
    creates: /usr/local/bin/k3s
  notify: restart k3s

# 3. Wait until Kubernetes API and Flannel (embedded CNI) are ready
- name: Wait for Kubernetes API to be ready
  when: inventory_hostname in groups['k3s_master']
  shell: kubectl get --raw='/readyz'
  register: apistatus
  retries: "{{ api_ready_retries }}"
  delay: "{{ api_ready_delay }}"
  until: "'ok' in apistatus.stdout"
  changed_when: false

- name: Wait for flannel (embedded CNI) to initialize
  when: inventory_hostname in groups['k3s_master']
  wait_for:
    path: /run/flannel/subnet.env
    state: present
    timeout: "{{ flannel_ready_timeout }}"
  changed_when: false

# 4. Retrieve and share the join token
- name: Retrieve join token
  when: inventory_hostname in groups['k3s_master']
  slurp:
    src: "{{ k3s_token_file }}"
  register: master_token

- name: Share join token
  when: inventory_hostname in groups['k3s_master']
  add_host:
    name: shared_k3s_token
    token: "{{ master_token.content | b64decode | trim }}"

# 5. Wait for token propagation before workers join
- name: Wait for token propagation
  when: inventory_hostname in groups['k3s_workers']
  wait_for:
    timeout: 60
  delegate_to: "{{ groups['k3s_master'][0] }}"

# 6. Install K3s agent (workers)
- name: Install K3s agent
  when: inventory_hostname in groups['k3s_workers']
  shell: |
    curl -sfL {{ k3s_install_url }} | \
      K3S_URL="https://{{ hostvars['master']['ansible_host'] }}:6443" \
      K3S_TOKEN="{{ hostvars['shared_k3s_token']['token'] }}" \
      INSTALL_K3S_CHANNEL={{ k3s_channel }} \
      INSTALL_K3S_EXEC="agent" sh -
  args:
    creates: /usr/local/bin/k3s-agent
  notify: restart k3s-agent

# 7. Wait for each service (server or agent) to become active
- name: Wait for K3s service active
  shell: |
    if systemctl is-active --quiet k3s; then echo active; \
    elif systemctl is-active --quiet k3s-agent; then echo active; \
    else echo inactive; fi
  register: service_status
  retries: "{{ service_ready_retries }}"
  delay: "{{ service_ready_delay }}"
  until: service_status.stdout.strip() == "active"
  changed_when: false

# 8. Run cluster verification (only on master)
- import_tasks: verify.yml
  when: inventory_hostname in groups['k3s_master']