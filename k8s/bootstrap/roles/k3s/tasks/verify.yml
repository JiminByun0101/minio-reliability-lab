---
# 1. Wait until the API server responds
- name: Wait for kube-apiserver health
  shell: kubectl get --raw='/healthz'
  register: apiserver_health
  retries: 10
  delay: 10
  until: "'ok' in apiserver_health.stdout"
  changed_when: false

# 2. Ensure all nodes have joined
- name: Wait for all nodes to register
  shell: kubectl get nodes --no-headers | wc -l
  register: node_count
  retries: 12
  delay: 10
  until: node_count.stdout|int == groups['k3s']|length
  changed_when: false

# 3. Show the cluster state
- name: Display registered nodes
  shell: kubectl get nodes -o wide
  register: node_status
  changed_when: false

- debug:
    msg: "{{ node_status.stdout_lines }}"